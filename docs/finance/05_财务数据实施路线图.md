# è´¢åŠ¡æ•°æ®å®æ–½è·¯çº¿å›¾

> **æ–‡æ¡£ç‰ˆæœ¬:** v1.0
> **æ›´æ–°æ—¥æœŸ:** 2025-11-15
> **é¡¹ç›®å‘¨æœŸ:** 5ä¸ªå·¥ä½œæ—¥
> **é¡¹ç›®è´Ÿè´£äºº:** å¾…å®š
> **æ–‡æ¡£çŠ¶æ€:** âœ… è®¡åˆ’å®šç¨¿

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªåŸºäºæœ¬åœ°PostgreSQLæ•°æ®åº“çš„è´¢åŠ¡æ•°æ®åˆ†æAIå¯¹è¯ç³»ç»Ÿï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

- âœ… **æ•°æ®æœ¬åœ°åŒ–** - å°†å¤–éƒ¨è´¢åŠ¡APIæ•°æ®åŒæ­¥åˆ°ç‹¬ç«‹PostgreSQLæ•°æ®åº“
- âœ… **æœˆåº¦è‡ªåŠ¨æ›´æ–°** - æ¯æœˆ1å·å‡Œæ™¨4ç‚¹è‡ªåŠ¨åŒæ­¥æœ€æ–°æ•°æ®
- âœ… **é«˜æ€§èƒ½æŸ¥è¯¢** - æŸ¥è¯¢å“åº”æ—¶é—´ä»2-5ç§’é™è‡³<100ms
- âœ… **æ™ºèƒ½å¯¹è¯** - åŸºäºOpenAI Function Callingçš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢
- âœ… **å®Œæ•´æ–‡æ¡£** - 5ä»½æŠ€æœ¯æ–‡æ¡£ + å…¬å¼€APIæ–‡æ¡£

### 1.2 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| **æ•°æ®åº“** | PostgreSQL | 15-alpine |
| **ORM** | SQLAlchemy | 2.0.30+ |
| **æ•°æ®åº“é©±åŠ¨** | psycopg[binary] | 3.1.19+ |
| **è¿ç§»å·¥å…·** | Alembic | æœ€æ–°ç‰ˆ |
| **HTTPå®¢æˆ·ç«¯** | requests | æœ€æ–°ç‰ˆ |
| **é‡è¯•åº“** | tenacity | æœ€æ–°ç‰ˆ |
| **AIæ¥å£** | OpenAI SDK | 1.0+ |
| **Webæ¡†æ¶** | FastAPI | ç°æœ‰ç‰ˆæœ¬ |
| **å®¹å™¨åŒ–** | Docker + Docker Compose | ç°æœ‰ç‰ˆæœ¬ |

### 1.3 æ•°æ®æº

- **APIåœ°å€:** `http://ailianhuan.xyz:8333/financeDate/dataList`
- **æ•°æ®è§„æ¨¡:** å½“å‰1016æ¡è®°å½•ï¼ˆ2023-11è‡³2025-09ï¼‰
- **æ•°æ®æ›´æ–°:** æ¯æœˆåˆæ–°å¢50-80æ¡
- **æ¥å£æ–‡æ¡£:** `http://ailianhuan.xyz:8333/doc.html`

---

## 2. å®æ–½é˜¶æ®µ

### Phase 0: ç¯å¢ƒå‡†å¤‡ï¼ˆ0.5å¤©ï¼‰

**æ—¶é—´å®‰æ’:** Day 0 ä¸‹åˆ

**ä»»åŠ¡æ¸…å•:**

- [ ] ç¡®è®¤é¡¹ç›®éœ€æ±‚å’ŒæŠ€æœ¯æ–¹æ¡ˆ
- [ ] Review 5ä»½æŠ€æœ¯æ–‡æ¡£
- [ ] å‡†å¤‡å¼€å‘ç¯å¢ƒ
  - [ ] å®‰è£…Docker Desktopï¼ˆå¦‚æœªå®‰è£…ï¼‰
  - [ ] å…‹éš†é¡¹ç›®ä»£ç 
  - [ ] å®‰è£…Pythonä¾èµ–
  - [ ] é…ç½®IDEï¼ˆVS Codeæ¨èï¼‰

**é¢„æœŸäº§å‡º:**
- å¼€å‘ç¯å¢ƒå°±ç»ª
- å›¢é˜Ÿå¯¹æ–¹æ¡ˆè¾¾æˆå…±è¯†

---

### Phase 1: æ•°æ®åº“åŸºç¡€è®¾æ–½ï¼ˆDay 1ï¼‰

**æ—¶é—´å®‰æ’:** Day 1 å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰

#### 1.1 åˆ›å»ºç‹¬ç«‹PostgreSQLå®ä¾‹

**ä»»åŠ¡ï¼š**
- [ ] æ›´æ–° `infra/docker-compose.yml`
  - æ·»åŠ  `postgres-finance` æœåŠ¡é…ç½®
  - é…ç½®ç«¯å£5433ã€å·æŒ‚è½½
- [ ] æ›´æ–° `.env.example`
  - æ·»åŠ  `FINANCE_DATABASE_URL` ç­‰é…ç½®
- [ ] åˆ›å»ºæœ¬åœ° `.env` æ–‡ä»¶ï¼ˆå¤åˆ¶`.env.example`ï¼‰
- [ ] å¯åŠ¨è´¢åŠ¡æ•°æ®åº“å®¹å™¨

**éªŒè¯ï¼š**
```bash
docker ps | grep finance
docker exec -it medpol-postgres-finance psql -U finance_user -d medpol_finance
```

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

#### 1.2 å®šä¹‰ORMæ¨¡å‹

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `common/persistence/finance_database.py`
  - å®ç° `FinanceBase` åŸºç±»
  - å®ç° `get_finance_engine()`
  - å®ç° `finance_session_scope()`
- [ ] åˆ›å»º `finance_sync_service/models.py`
  - å®šä¹‰ `FinanceDataORM` æ¨¡å‹
  - å®šä¹‰ `FinanceSyncLogORM` æ¨¡å‹
  - æ·»åŠ ç´¢å¼•å’Œçº¦æŸ

**éªŒè¯ï¼š**
```python
from common.persistence.finance_database import finance_session_scope
with finance_session_scope() as session:
    print("Session connected!")
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 1.3 ç¼–å†™Alembicè¿ç§»

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `alembic_finance.ini`
- [ ] åˆ›å»º `migrations_finance/` ç›®å½•
- [ ] ç¼–å†™ `migrations_finance/env.py`
- [ ] ç”Ÿæˆåˆå§‹è¿ç§»è„šæœ¬ `0001_init_finance_schema.py`
- [ ] æ‰§è¡Œè¿ç§»

**å‘½ä»¤ï¼š**
```bash
alembic -c alembic_finance.ini init migrations_finance
alembic -c alembic_finance.ini revision --autogenerate -m "init finance schema"
alembic -c alembic_finance.ini upgrade head
```

**éªŒè¯ï¼š**
```sql
-- è¿›å…¥æ•°æ®åº“
\dt  -- æŸ¥çœ‹è¡¨ç»“æ„
\d finance_data  -- æŸ¥çœ‹finance_dataè¡¨è¯¦æƒ…
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 1.4 æ›´æ–°é…ç½®æ–‡ä»¶

**ä»»åŠ¡ï¼š**
- [ ] æ›´æ–° `common/utils/config.py`
  - æ·»åŠ  `finance_database_url` ç­‰å­—æ®µ
- [ ] æ›´æ–° `.env.example`
  - å®Œå–„æ³¨é‡Šå’Œé»˜è®¤å€¼

**éªŒè¯ï¼š**
```python
from common.utils.config import get_settings
settings = get_settings()
print(settings.finance_database_url)
```

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

#### 1.5 æµ‹è¯•æ•°æ®åº“è¿æ¥

**ä»»åŠ¡ï¼š**
- [ ] ç¼–å†™æµ‹è¯•è„šæœ¬ `scripts/test_finance_db_connection.py`
- [ ] æµ‹è¯•Sessionåˆ›å»º
- [ ] æµ‹è¯•ç®€å•æ’å…¥/æŸ¥è¯¢
- [ ] æµ‹è¯•å”¯ä¸€çº¦æŸ

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

**Phase 1 äº¤ä»˜ç‰©:**
- âœ… ç‹¬ç«‹PostgreSQLå®ä¾‹è¿è¡Œä¸­ï¼ˆç«¯å£5433ï¼‰
- âœ… æ•°æ®åº“è¡¨ç»“æ„åˆ›å»ºå®Œæˆï¼ˆfinance_data + finance_sync_logï¼‰
- âœ… Sessionè¿æ¥æ­£å¸¸
- âœ… Alembicè¿ç§»è„šæœ¬å¯ç”¨

---

### Phase 2: åŒæ­¥æœåŠ¡å¼€å‘ï¼ˆDay 2ï¼‰

**æ—¶é—´å®‰æ’:** Day 2 å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰

#### 2.1 å¼€å‘APIå®¢æˆ·ç«¯

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `finance_sync_service/finance_api_client.py`
  - å®ç° `FinanceAPIClient` ç±»
  - å®ç° `get_all_data()` æ–¹æ³•
  - å®ç° `get_data_by_month()` æ–¹æ³•
  - æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆtenacityï¼‰
  - æ·»åŠ é”™è¯¯å¤„ç†

**éªŒè¯ï¼š**
```python
from finance_sync_service.finance_api_client import FinanceAPIClient
client = FinanceAPIClient()
data = client.get_all_data()
print(f"Total records: {len(data)}")  # åº”è¯¥çº¦1016æ¡
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 2.2 å®ç°åŒæ­¥Worker

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `finance_sync_service/utils.py`
  - å®ç° `convert_to_orm()` æ•°æ®è½¬æ¢
  - å®ç° `validate_finance_record()` æ•°æ®æ ¡éªŒ
- [ ] åˆ›å»º `finance_sync_service/repository.py`
  - å®ç° `FinanceDataRepository` ç±»
  - å®ç° `bulk_upsert()` æ‰¹é‡æ’å…¥
  - å®ç°æŸ¥è¯¢æ–¹æ³•
- [ ] åˆ›å»º `finance_sync_service/sync_worker.py`
  - å®ç° `sync_full()` å…¨é‡åŒæ­¥
  - å®ç° `sync_incremental()` å¢é‡åŒæ­¥
  - å®ç°æ—¥å¿—è®°å½•

**éªŒè¯ï¼š**
```python
# æµ‹è¯•æ•°æ®è½¬æ¢
raw_item = {...}  # ä»APIè·å–çš„åŸå§‹æ•°æ®
orm_obj = convert_to_orm(raw_item)
assert orm_obj.company_no == "lhjt"
```

**é¢„è®¡è€—æ—¶:** 4å°æ—¶

#### 2.3 é¦–æ¬¡å…¨é‡åŒæ­¥

**ä»»åŠ¡ï¼š**
- [ ] ç¼–å†™ `scripts/finance_initial_sync.py`
- [ ] æ‰§è¡Œé¦–æ¬¡å…¨é‡åŒæ­¥
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§

**æ‰§è¡Œï¼š**
```bash
python scripts/finance_initial_sync.py
```

**éªŒè¯ï¼š**
```sql
SELECT COUNT(*) FROM finance_data;  -- åº”è¯¥çº¦1016æ¡
SELECT COUNT(DISTINCT keep_date) FROM finance_data;  -- åº”è¯¥22ä¸ªæœˆ

-- æ£€æŸ¥é‡å¤
SELECT company_no, type_no, keep_date, COUNT(*)
FROM finance_data
GROUP BY company_no, type_no, keep_date
HAVING COUNT(*) > 1;  -- åº”è¯¥è¿”å›0è¡Œ
```

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

#### 2.4 æµ‹è¯•å¢é‡åŒæ­¥

**ä»»åŠ¡ï¼š**
- [ ] æ‰‹åŠ¨è§¦å‘å¢é‡åŒæ­¥ï¼ˆæŒ‡å®šæœˆä»½ï¼‰
- [ ] éªŒè¯å»é‡é€»è¾‘
- [ ] æµ‹è¯•é”™è¯¯é‡è¯•

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

**Phase 2 äº¤ä»˜ç‰©:**
- âœ… APIå®¢æˆ·ç«¯åŠŸèƒ½å®Œæ•´
- âœ… åŒæ­¥Workeræ­£å¸¸è¿è¡Œ
- âœ… å†å²æ•°æ®å…¨é‡åŒæ­¥å®Œæˆï¼ˆ1016æ¡ï¼‰
- âœ… å¢é‡åŒæ­¥æµ‹è¯•é€šè¿‡

---

### Phase 3: è°ƒåº¦é›†æˆï¼ˆDay 3ï¼‰

**æ—¶é—´å®‰æ’:** Day 3 å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰

#### 3.1 æ³¨å†Œå®šæ—¶ä»»åŠ¡

**ä»»åŠ¡ï¼š**
- [ ] ç¼–å†™ `scripts/seed_finance_sync_job.py`
  - åˆ›å»ºè´¢åŠ¡æ•°æ®æºï¼ˆfinance_apiï¼‰
  - åˆ›å»ºCrawlerJobORMä»»åŠ¡
  - è®¾ç½®Cronè¡¨è¾¾å¼ï¼š`0 4 1 * *`
- [ ] æ‰§è¡Œæ³¨å†Œè„šæœ¬

**æ‰§è¡Œï¼š**
```bash
python scripts/seed_finance_sync_job.py
```

**éªŒè¯ï¼š**
```bash
# é€šè¿‡APIæŸ¥è¯¢ä»»åŠ¡
curl http://localhost:8000/v1/crawler-jobs | jq '.data[] | select(.crawler_name=="finance_sync")'
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 3.2 é›†æˆåˆ°è°ƒåº¦å™¨

**ä»»åŠ¡ï¼š**
- [ ] æ›´æ–° `scheduler_service/job_runner.py`
  - æ·»åŠ  `finance_sync` ä»»åŠ¡è·¯ç”±
  - è°ƒç”¨ `sync_incremental()` æ–¹æ³•
- [ ] æµ‹è¯•æ‰‹åŠ¨è§¦å‘

**éªŒè¯ï¼š**
```bash
# æ‰‹åŠ¨è§¦å‘ä»»åŠ¡
curl -X POST http://localhost:8000/v1/crawler-jobs/{job_id}/run
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 3.3 é…ç½®æ—¥å¿—ç›‘æ§

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `api_gateway/routers/finance_sync.py`
  - å®ç° `GET /v1/finance-sync/logs` æ¥å£
  - å®ç° `POST /v1/finance-sync/trigger` æ¥å£
- [ ] æ›´æ–° `api_gateway/main.py`ï¼ˆæ·»åŠ è·¯ç”±ï¼‰

**éªŒè¯ï¼š**
```bash
# æŸ¥è¯¢åŒæ­¥æ—¥å¿—
curl http://localhost:8000/v1/finance-sync/logs

# æ‰‹åŠ¨è§¦å‘åŒæ­¥
curl -X POST http://localhost:8000/v1/finance-sync/trigger?month=2024-03
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 3.4 æµ‹è¯•å®šæ—¶æ‰§è¡Œ

**ä»»åŠ¡ï¼š**
- [ ] å¯åŠ¨è°ƒåº¦å™¨ `python scripts/run_scheduler.py`
- [ ] æ‰‹åŠ¨ä¿®æ”¹ä»»åŠ¡çš„ `next_run_at` ä¸ºå½“å‰æ—¶é—´
- [ ] è§‚å¯Ÿè°ƒåº¦å™¨æ˜¯å¦è‡ªåŠ¨è§¦å‘ä»»åŠ¡
- [ ] æ£€æŸ¥æ—¥å¿—

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

**Phase 3 äº¤ä»˜ç‰©:**
- âœ… å®šæ—¶ä»»åŠ¡æ³¨å†ŒæˆåŠŸ
- âœ… è°ƒåº¦å™¨å¯è‡ªåŠ¨è§¦å‘åŒæ­¥
- âœ… æ—¥å¿—ç›‘æ§æ¥å£å¯ç”¨
- âœ… æ‰‹åŠ¨è§¦å‘åŠŸèƒ½æ­£å¸¸

---

### Phase 4: AIå·¥å…·é‡æ„ï¼ˆDay 4ï¼‰

**æ—¶é—´å®‰æ’:** Day 4 å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰

#### 4.1 å®ç°æŸ¥è¯¢Repository

**ä»»åŠ¡ï¼š**
- [ ] æ‰©å±• `finance_sync_service/repository.py`
  - å®ç° `query_with_filters()` å¤šç»´åº¦æŸ¥è¯¢
  - å®ç° `get_recent_months()` æœ€è¿‘NæœˆæŸ¥è¯¢
  - å®ç° `query_by_type_and_month()` æ’åæŸ¥è¯¢
  - å®ç° `query_multi_companies()` å¤šå…¬å¸æŸ¥è¯¢
  - æ·»åŠ èšåˆæŸ¥è¯¢æ–¹æ³•

**éªŒè¯ï¼š**
```python
from common.persistence.finance_database import finance_session_scope
from finance_sync_service.repository import FinanceDataRepository

with finance_session_scope() as session:
    repo = FinanceDataRepository(session)
    records = repo.query_with_filters({
        "company_names": ["é›†å›¢(åˆ)"],
        "type_no": "01",
        "start_date": date(2024, 1, 1),
        "end_date": date(2024, 3, 1)
    })
    print(f"Found {len(records)} records")
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 4.2 å¼€å‘å·¥å…·å‡½æ•°

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»º `common/clients/finance_data/` ç›®å½•
- [ ] åˆ›å»º `common/clients/finance_data/tools.py`
  - å®ç° `query_finance_data()`
  - å®ç° `analyze_finance_trend()`
  - å®ç° `get_company_ranking()`
  - å®ç° `compare_companies()`
  - å®ç° `get_available_months()`
  - å®ç° `get_finance_summary()`
  - å®ç° `execute_finance_tool()` è·¯ç”±å™¨
- [ ] åˆ›å»º `common/clients/finance_data/schemas.py`
  - å®šä¹‰ `FINANCE_TOOLS` OpenAI Function Calling Schema

**éªŒè¯ï¼š**
```python
from common/clients/finance_data.tools import query_finance_data

result = query_finance_data(
    company_names=["é›†å›¢(åˆ)"],
    type_no="01",
    start_month="2024-03",
    end_month="2024-03"
)
print(result)  # åº”è¯¥è¿”å›Dict with records
```

**é¢„è®¡è€—æ—¶:** 3å°æ—¶

#### 4.3 æ›´æ–°AIå¯¹è¯è·¯ç”±

**ä»»åŠ¡ï¼š**
- [ ] æ›´æ–° `api_gateway/routers/ai_chat.py`
  - å¯¼å…¥æ–°çš„ `FINANCE_TOOLS`
  - å¯¼å…¥ `execute_finance_tool`
  - æ›´æ–° `SYSTEM_PROMPT`
  - æ›´æ–°å·¥å…·è°ƒç”¨é€»è¾‘

**éªŒè¯ï¼š**
```bash
# æµ‹è¯•AIå¯¹è¯
curl -X POST http://localhost:8000/v1/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"messages": [{"role": "user", "content": "é›†å›¢2024å¹´3æœˆçš„è¥ä¸šæ”¶å…¥æ˜¯å¤šå°‘ï¼Ÿ"}]}'
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 4.4 æ€§èƒ½æµ‹è¯•

**ä»»åŠ¡ï¼š**
- [ ] æµ‹è¯•å•æ¬¡æŸ¥è¯¢å“åº”æ—¶é—´
- [ ] æµ‹è¯•å¹¶å‘10ä¸ªè¯·æ±‚
- [ ] ä½¿ç”¨EXPLAIN ANALYZEéªŒè¯ç´¢å¼•ä½¿ç”¨
- [ ] ä¼˜åŒ–æ…¢æŸ¥è¯¢

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

**Phase 4 äº¤ä»˜ç‰©:**
- âœ… 6ä¸ªå·¥å…·å‡½æ•°å…¨éƒ¨å®ç°
- âœ… AIå¯¹è¯åŠŸèƒ½æ­£å¸¸
- âœ… æŸ¥è¯¢å“åº”æ—¶é—´<100ms
- âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡

---

### Phase 5: æµ‹è¯•ä¸éƒ¨ç½²ï¼ˆDay 5ï¼‰

**æ—¶é—´å®‰æ’:** Day 5 å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰

#### 5.1 é›†æˆæµ‹è¯•

**ä»»åŠ¡ï¼š**
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šç”¨æˆ·æé—® â†’ AIå›ç­”
- [ ] å¤šè½®å¯¹è¯æµ‹è¯•
- [ ] å¤æ‚æŸ¥è¯¢æµ‹è¯•ï¼ˆè¶‹åŠ¿ã€æ’åã€å¯¹æ¯”ï¼‰
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ï¼š**
```bash
# ç”¨ä¾‹1ï¼šåŸºç¡€æŸ¥è¯¢
"é›†å›¢2024å¹´3æœˆçš„è¥ä¸šæ”¶å…¥æ˜¯å¤šå°‘ï¼Ÿ"

# ç”¨ä¾‹2ï¼šè¶‹åŠ¿åˆ†æ
"åˆ†æè‚¡ä»½å…¬å¸æœ€è¿‘åŠå¹´çš„åˆ©æ¶¦è¶‹åŠ¿"

# ç”¨ä¾‹3ï¼šå…¬å¸æ’å
"2024å¹´3æœˆè¥ä¸šæ”¶å…¥æ’åå‰5çš„å…¬å¸"

# ç”¨ä¾‹4ï¼šå¤šå…¬å¸å¯¹æ¯”
"å¯¹æ¯”é›†å›¢å’Œè‚¡ä»½å…¬å¸2024å¹´Q1çš„è¥æ”¶"

# ç”¨ä¾‹5ï¼šå¤šè½®å¯¹è¯
å¯¹è¯1ï¼š"é›†å›¢æœ€è¿‘çš„è¥æ”¶å¦‚ä½•ï¼Ÿ"
å¯¹è¯2ï¼š"é‚£åˆ©æ¶¦å‘¢ï¼Ÿ"
å¯¹è¯3ï¼š"å¯¹æ¯”ä¸€ä¸‹è‚¡ä»½å…¬å¸"

# ç”¨ä¾‹6ï¼šé”™è¯¯å¤„ç†
"æŸ¥è¯¢2020å¹´çš„æ•°æ®"  # åº”æç¤ºæ•°æ®ä¸å­˜åœ¨
```

**é¢„è®¡è€—æ—¶:** 3å°æ—¶

#### 5.2 æ€§èƒ½æµ‹è¯•

**ä»»åŠ¡ï¼š**
- [ ] å•ç”¨æˆ·æµ‹è¯•ï¼ˆå»¶è¿Ÿã€ååé‡ï¼‰
- [ ] å¹¶å‘æµ‹è¯•ï¼ˆ10/50/100å¹¶å‘ï¼‰
- [ ] æ•°æ®åº“è¿æ¥æ± æµ‹è¯•
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥

**å·¥å…·ï¼š**
- Apache Bench (ab)
- wrk
- Pythonè„šæœ¬

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 5.3 éƒ¨ç½²å‡†å¤‡

**ä»»åŠ¡ï¼š**
- [ ] æ›´æ–°ç”Ÿäº§ç¯å¢ƒ `.env` é…ç½®
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»
- [ ] é¦–æ¬¡å…¨é‡åŒæ­¥
- [ ] æ³¨å†Œå®šæ—¶ä»»åŠ¡
- [ ] é…ç½®Nginxï¼ˆå¦‚éœ€ï¼‰
- [ ] å¯åŠ¨æ‰€æœ‰æœåŠ¡

**éƒ¨ç½²å‘½ä»¤ï¼š**
```bash
# 1. å¯åŠ¨åŸºç¡€è®¾æ–½
docker compose -f infra/docker-compose.yml up -d

# 2. æ‰§è¡Œè¿ç§»
alembic -c alembic_finance.ini upgrade head

# 3. é¦–æ¬¡åŒæ­¥
python scripts/finance_initial_sync.py

# 4. æ³¨å†Œå®šæ—¶ä»»åŠ¡
python scripts/seed_finance_sync_job.py

# 5. å¯åŠ¨è°ƒåº¦å™¨
nohup python scripts/run_scheduler.py --interval 60 > scheduler.log 2>&1 &

# 6. å¯åŠ¨APIç½‘å…³
uvicorn api_gateway.main:app --host 0.0.0.0 --port 8000
```

**é¢„è®¡è€—æ—¶:** 2å°æ—¶

#### 5.4 éªŒæ”¶æµ‹è¯•

**ä»»åŠ¡ï¼š**
- [ ] æ‰§è¡ŒéªŒæ”¶æ¸…å•ï¼ˆè§ä¸‹æ–‡ï¼‰
- [ ] ç”¨æˆ·æ¼”ç¤º
- [ ] æ”¶é›†åé¦ˆ
- [ ] æ–‡æ¡£æœ€ç»ˆå®¡æŸ¥

**é¢„è®¡è€—æ—¶:** 1å°æ—¶

**Phase 5 äº¤ä»˜ç‰©:**
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ
- âœ… éªŒæ”¶æ ‡å‡†è¾¾æ ‡
- âœ… æ–‡æ¡£é½å…¨

---

## 3. æŠ€æœ¯è¦ç‚¹

### 3.1 æ•°æ®åº“Sessionç®¡ç†

```python
# é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¯¼è‡´è¿æ¥æ³„æ¼ï¼‰
from common.persistence.finance_database import get_finance_session_factory
session_factory = get_finance_session_factory()
session = session_factory()
# ... ä½¿ç”¨session
# å¿˜è®°å…³é—­ï¼

# æ­£ç¡®ç¤ºä¾‹ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
from common.persistence.finance_database import finance_session_scope
with finance_session_scope() as session:
    repo = FinanceDataRepository(session)
    data = repo.query(...)
# è‡ªåŠ¨commit/rollback/close
```

### 3.2 å»é‡ç­–ç•¥

ä½¿ç”¨PostgreSQLçš„ `ON CONFLICT DO NOTHING`ï¼š

```python
stmt = insert(FinanceDataORM).values([...]).on_conflict_do_nothing(
    index_elements=["company_no", "type_no", "keep_date"]
)
```

### 3.3 OpenAI SDK v1.0 API

```python
# æ–°APIï¼ˆv1.0+ï¼‰
from openai import OpenAI

client = OpenAI(api_key=settings.openai_api_key)
response = client.chat.completions.create(
    model="gpt-4",
    messages=messages,
    tools=FINANCE_TOOLS,
    tool_choice="auto"
)

# è®¿é—®å·¥å…·è°ƒç”¨
if response.choices[0].message.tool_calls:
    for tool_call in response.choices[0].message.tool_calls:
        tool_name = tool_call.function.name
        arguments = json.loads(tool_call.function.arguments)
        result = execute_finance_tool(tool_name, arguments)
```

### 3.4 Alembic å¤šæ•°æ®åº“ç®¡ç†

```bash
# ä¸šåŠ¡åº“è¿ç§»
alembic upgrade head

# è´¢åŠ¡åº“è¿ç§»
alembic -c alembic_finance.ini upgrade head
```

### 3.5 ç´¢å¼•ä¼˜åŒ–

ç¡®ä¿å¤åˆç´¢å¼•é¡ºåºæ­£ç¡®ï¼š

```sql
-- å¥½çš„ç´¢å¼•ï¼ˆæ”¯æŒå‰ç¼€æŸ¥è¯¢ï¼‰
CREATE INDEX idx_query ON finance_data(company_no, type_no, keep_date);

-- æŸ¥è¯¢ä¼šç”¨åˆ°ç´¢å¼•
WHERE company_no = 'lhjt' AND type_no = '01' AND keep_date = '2024-03-01'
WHERE company_no = 'lhjt' AND type_no = '01'
WHERE company_no = 'lhjt'

-- æŸ¥è¯¢ä¸ä¼šç”¨åˆ°ç´¢å¼•
WHERE type_no = '01' AND keep_date = '2024-03-01'
```

---

## 4. æµ‹è¯•è®¡åˆ’

### 4.1 å•å…ƒæµ‹è¯•

**æ–‡ä»¶ï¼š** `tests/finance_sync/test_repository.py`

```python
def test_bulk_upsert():
    """æµ‹è¯•æ‰¹é‡æ’å…¥å’Œå»é‡"""
    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        # æ’å…¥100æ¡
        records = [create_test_record(i) for i in range(100)]
        count = repo.bulk_upsert(records)
        assert count == 100

        # é‡å¤æ’å…¥ï¼Œåº”è¯¥è·³è¿‡
        count = repo.bulk_upsert(records)
        assert count == 0

def test_query_with_filters():
    """æµ‹è¯•å¤šç»´åº¦æŸ¥è¯¢"""
    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        records = repo.query_with_filters({
            "company_names": ["é›†å›¢(åˆ)"],
            "type_no": "01",
            "start_date": date(2024, 1, 1),
            "end_date": date(2024, 3, 1)
        })

        assert len(records) == 3  # 1æœˆã€2æœˆã€3æœˆ
        assert all(r.company_name == "é›†å›¢(åˆ)" for r in records)
        assert all(r.type_no == "01" for r in records)
```

### 4.2 é›†æˆæµ‹è¯•

**æ–‡ä»¶ï¼š** `tests/finance_sync/test_integration.py`

```python
def test_full_sync_pipeline():
    """æµ‹è¯•å®Œæ•´åŒæ­¥æµç¨‹"""
    # 1. è°ƒç”¨API
    client = FinanceAPIClient()
    raw_data = client.get_all_data()
    assert len(raw_data) > 0

    # 2. æ•°æ®è½¬æ¢
    records = [convert_to_orm(item) for item in raw_data]

    # 3. å…¥åº“
    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)
        count = repo.bulk_upsert(records)
        assert count > 0

def test_ai_chat_query():
    """æµ‹è¯•AIå¯¹è¯æŸ¥è¯¢"""
    response = requests.post(
        "http://localhost:8000/v1/ai/chat",
        json={
            "messages": [
                {"role": "user", "content": "é›†å›¢2024å¹´3æœˆçš„è¥ä¸šæ”¶å…¥æ˜¯å¤šå°‘ï¼Ÿ"}
            ]
        }
    )

    assert response.status_code == 200
    data = response.json()
    assert "message" in data
    assert "tool_calls" in data
    assert len(data["tool_calls"]) > 0
    assert data["tool_calls"][0]["tool"] == "query_finance_data"
```

### 4.3 æ€§èƒ½æµ‹è¯•

**æ–‡ä»¶ï¼š** `tests/finance_sync/test_performance.py`

```python
def test_query_performance():
    """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼ˆåº”<100msï¼‰"""
    from common.persistence.finance_database import finance_session_scope
    from finance_sync_service.repository import FinanceDataRepository
    import time

    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        start = time.time()
        records = repo.query_with_filters({
            "company_names": ["é›†å›¢(åˆ)"],
            "type_no": "01",
            "start_date": date(2024, 1, 1),
            "end_date": date(2024, 3, 1)
        })
        elapsed = (time.time() - start) * 1000

        assert elapsed < 100, f"Query too slow: {elapsed}ms"
```

---

## 5. éƒ¨ç½²æ¸…å•

### 5.1 ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶ï¼š** `.env`

```ini
# ========== è´¢åŠ¡æ•°æ®åº“é…ç½® ==========
FINANCE_DATABASE_URL=postgresql+psycopg://finance_user:SecurePass123@localhost:5433/medpol_finance
FINANCE_DB_POOL_SIZE=20
FINANCE_DB_MAX_OVERFLOW=40
FINANCE_DB_POOL_TIMEOUT=30
FINANCE_DB_ECHO=false

# ========== AIé…ç½® ==========
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1
AI_CHAT_MODEL=gpt-4

# ========== å…¶ä»–é…ç½® ==========
DATABASE_URL=postgresql+psycopg://medpol:medpol@localhost:5432/medpol
REDIS_URL=redis://localhost:6379/0
```

### 5.2 Dockerå®¹å™¨å¯åŠ¨

```bash
# å¯åŠ¨æ‰€æœ‰åŸºç¡€è®¾æ–½
docker compose -f infra/docker-compose.yml up -d

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep medpol

# åº”è¯¥çœ‹åˆ°ï¼š
# - medpol-postgresï¼ˆä¸šåŠ¡åº“ï¼‰
# - medpol-postgres-financeï¼ˆè´¢åŠ¡åº“ï¼‰
# - medpol-redis
```

### 5.3 æ•°æ®åº“åˆå§‹åŒ–

```bash
# 1. æ‰§è¡Œè¿ç§»
alembic -c alembic_finance.ini upgrade head

# 2. éªŒè¯è¡¨ç»“æ„
docker exec -it medpol-postgres-finance psql -U finance_user -d medpol_finance -c "\dt"

# 3. é¦–æ¬¡å…¨é‡åŒæ­¥
python scripts/finance_initial_sync.py

# 4. éªŒè¯æ•°æ®
docker exec -it medpol-postgres-finance psql -U finance_user -d medpol_finance -c "SELECT COUNT(*) FROM finance_data;"
```

### 5.4 å®šæ—¶ä»»åŠ¡é…ç½®

```bash
# æ³¨å†Œå®šæ—¶ä»»åŠ¡
python scripts/seed_finance_sync_job.py

# å¯åŠ¨è°ƒåº¦å™¨ï¼ˆåå°è¿è¡Œï¼‰
nohup python scripts/run_scheduler.py --interval 60 > logs/scheduler.log 2>&1 &

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/scheduler.log
```

### 5.5 APIæœåŠ¡å¯åŠ¨

```bash
# å¯åŠ¨APIç½‘å…³
uvicorn api_gateway.main:app --host 0.0.0.0 --port 8000 --workers 4

# æˆ–ä½¿ç”¨Gunicornï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
gunicorn api_gateway.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶

- [ ] **æ•°æ®åº“**
  - [ ] ç‹¬ç«‹PostgreSQLå®ä¾‹è¿è¡Œæ­£å¸¸ï¼ˆç«¯å£5433ï¼‰
  - [ ] finance_dataè¡¨å­˜åœ¨ä¸”ç»“æ„æ­£ç¡®
  - [ ] finance_sync_logè¡¨å­˜åœ¨ä¸”ç»“æ„æ­£ç¡®
  - [ ] å”¯ä¸€çº¦æŸç”Ÿæ•ˆï¼ˆæ— æ³•æ’å…¥é‡å¤æ•°æ®ï¼‰

- [ ] **æ•°æ®åŒæ­¥**
  - [ ] å†å²æ•°æ®åŒæ­¥å®Œæˆï¼ˆ1016æ¡ï¼‰
  - [ ] æ— é‡å¤æ•°æ®
  - [ ] æ•°æ®å®Œæ•´æ€§æ ¡éªŒé€šè¿‡
  - [ ] å®šæ—¶ä»»åŠ¡å·²æ³¨å†Œï¼ˆæ¯æœˆ1å·å‡Œæ™¨4ç‚¹ï¼‰

- [ ] **AIå¯¹è¯**
  - [ ] åŸºç¡€æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
  - [ ] è¶‹åŠ¿åˆ†æåŠŸèƒ½æ­£å¸¸
  - [ ] å…¬å¸æ’ååŠŸèƒ½æ­£å¸¸
  - [ ] å¤šå…¬å¸å¯¹æ¯”åŠŸèƒ½æ­£å¸¸
  - [ ] å¤šè½®å¯¹è¯åŠŸèƒ½æ­£å¸¸

- [ ] **APIæ¥å£**
  - [ ] `POST /v1/ai/chat` æ¥å£æ­£å¸¸
  - [ ] `GET /v1/finance-sync/logs` æ¥å£æ­£å¸¸
  - [ ] `POST /v1/finance-sync/trigger` æ¥å£æ­£å¸¸

### 6.2 æ€§èƒ½éªŒæ”¶

- [ ] **æŸ¥è¯¢æ€§èƒ½**
  - [ ] å•æ¬¡æ•°æ®åº“æŸ¥è¯¢ < 100ms
  - [ ] AIå¯¹è¯æ€»å“åº”æ—¶é—´ < 2ç§’
  - [ ] å¹¶å‘10ä¸ªè¯·æ±‚æ— é”™è¯¯

- [ ] **åŒæ­¥æ€§èƒ½**
  - [ ] å…¨é‡åŒæ­¥ï¼ˆ1016æ¡ï¼‰< 30ç§’
  - [ ] å¢é‡åŒæ­¥ï¼ˆ50-80æ¡ï¼‰< 10ç§’

### 6.3 ç¨³å®šæ€§éªŒæ”¶

- [ ] **é”™è¯¯å¤„ç†**
  - [ ] APIè¶…æ—¶è‡ªåŠ¨é‡è¯•
  - [ ] æ•°æ®åº“è¿æ¥å¤±è´¥è‡ªåŠ¨é‡è¿
  - [ ] é‡å¤æ•°æ®è‡ªåŠ¨è·³è¿‡
  - [ ] é”™è¯¯ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—

- [ ] **ç›‘æ§å‘Šè­¦**
  - [ ] åŒæ­¥æ—¥å¿—å¯æŸ¥è¯¢
  - [ ] å¤±è´¥ä»»åŠ¡æœ‰è®°å½•
  - [ ] æ•°æ®ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡

### 6.4 æ–‡æ¡£éªŒæ”¶

- [ ] **æŠ€æœ¯æ–‡æ¡£ï¼ˆ5ä»½ï¼‰**
  - [ ] 01_è´¢åŠ¡æ•°æ®æ¥å£æ–‡æ¡£.md
  - [ ] 02_è´¢åŠ¡æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ.md
  - [ ] 03_è´¢åŠ¡æ•°æ®åŒæ­¥æ–¹æ¡ˆ.md
  - [ ] 04_AIå¯¹è¯é›†æˆæ–¹æ¡ˆ_v2.md
  - [ ] 05_è´¢åŠ¡æ•°æ®å®æ–½è·¯çº¿å›¾.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰

- [ ] **å…¬å¼€APIæ–‡æ¡£**
  - [ ] PUBLIC_API.md ç¬¬5èŠ‚å·²æ›´æ–°

---

## 7. é£é™©ä¸åº”å¯¹

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| **æ•°æ®åº“è¿ç§»å¤±è´¥** | ä¸­ | é«˜ | æå‰å¤‡ä»½ã€å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ã€å‡†å¤‡å›æ»šè„šæœ¬ |
| **APIè¶…æ—¶** | ä¸­ | ä¸­ | å®ç°é‡è¯•æœºåˆ¶ã€è®¾ç½®åˆç†è¶…æ—¶æ—¶é—´ |
| **æ•°æ®ä¸ä¸€è‡´** | ä½ | é«˜ | æ·»åŠ æ ¡éªŒè„šæœ¬ã€å®šæœŸå¯¹è´¦ |
| **æ€§èƒ½ä¸è¾¾æ ‡** | ä½ | ä¸­ | ä¼˜åŒ–ç´¢å¼•ã€æ·»åŠ ç¼“å­˜ã€å‡çº§æœåŠ¡å™¨ |
| **OpenAI APIé™æµ** | ä¸­ | ä¸­ | é…ç½®Fallback Providerï¼ˆDeepSeekï¼‰|

### 7.2 è¿›åº¦é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| **ä»»åŠ¡ä¼°æ—¶ä¸å‡†** | é«˜ | ä¸­ | é¢„ç•™20%ç¼“å†²æ—¶é—´ã€æ¯æ—¥Reviewè¿›åº¦ |
| **éœ€æ±‚å˜æ›´** | ä¸­ | é«˜ | å†»ç»“éœ€æ±‚ã€å˜æ›´èµ°æµç¨‹ |
| **äººå‘˜ä¸è¶³** | ä½ | é«˜ | æå‰åŸ¹è®­ã€æ–‡æ¡£é½å…¨ |

### 7.3 ä¸šåŠ¡é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| **å¤–éƒ¨APIå˜æ›´** | ä¸­ | é«˜ | ç›‘æ§APIå˜åŒ–ã€ä¿ç•™å†å²æ•°æ® |
| **æ•°æ®è´¨é‡é—®é¢˜** | ä¸­ | ä¸­ | æ•°æ®æ ¡éªŒã€å¼‚å¸¸å€¼æ£€æµ‹ |
| **ç”¨æˆ·åé¦ˆé—®é¢˜å¤š** | ä¸­ | ä½ | å®Œå–„æ–‡æ¡£ã€æä¾›ç¤ºä¾‹ |

---

## 8. åç»­ä¼˜åŒ–è®¡åˆ’

### 8.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

- [ ] æ·»åŠ Streamingå“åº”æ”¯æŒ
- [ ] ä¼˜åŒ–System Prompt
- [ ] æ·»åŠ æ›´å¤šç¤ºä¾‹å¯¹è¯
- [ ] å®Œå–„é”™è¯¯æç¤º

### 8.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ1-3æœˆï¼‰

- [ ] é›†æˆæ›´å¤šè´¢åŠ¡æ•°æ®æº
- [ ] æ”¯æŒè‡ªå®šä¹‰æŠ¥è¡¨
- [ ] æ·»åŠ æ•°æ®å¯è§†åŒ–
- [ ] å®ç°ç”¨æˆ·åé¦ˆæœºåˆ¶

### 8.3 é•¿æœŸä¼˜åŒ–ï¼ˆ3æœˆ+ï¼‰

- [ ] æœºå™¨å­¦ä¹ é¢„æµ‹æ¨¡å‹
- [ ] è‡ªåŠ¨åŒ–å¼‚å¸¸æ£€æµ‹
- [ ] ç§»åŠ¨ç«¯æ”¯æŒ
- [ ] å¤šè¯­è¨€æ”¯æŒ

---

## 9. é™„å½•

### 9.1 å¸¸ç”¨å‘½ä»¤

```bash
# æ•°æ®åº“ç®¡ç†
docker exec -it medpol-postgres-finance psql -U finance_user -d medpol_finance

# è¿ç§»ç®¡ç†
alembic -c alembic_finance.ini upgrade head
alembic -c alembic_finance.ini downgrade -1

# åŒæ­¥ç®¡ç†
python scripts/finance_initial_sync.py
python scripts/seed_finance_sync_job.py

# æ—¥å¿—æŸ¥çœ‹
tail -f logs/scheduler.log
docker logs medpol-postgres-finance

# æ€§èƒ½ç›‘æ§
docker stats medpol-postgres-finance
```

### 9.2 æ•…éšœæ’æŸ¥

**é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep finance

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -an | findstr 5433

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs medpol-postgres-finance

# æµ‹è¯•è¿æ¥
psql "postgresql://finance_user:finance_password@localhost:5433/medpol_finance"
```

**é—®é¢˜ï¼šåŒæ­¥å¤±è´¥**
```bash
# æŸ¥è¯¢åŒæ­¥æ—¥å¿—
curl http://localhost:8000/v1/finance-sync/logs

# æ‰‹åŠ¨é‡è¯•
python scripts/finance_initial_sync.py

# æ£€æŸ¥APIå¯ç”¨æ€§
curl http://ailianhuan.xyz:8333/financeDate/dataList
```

### 9.3 è”ç³»æ–¹å¼

- **é¡¹ç›®è´Ÿè´£äºº:** å¾…å®š
- **æŠ€æœ¯æ”¯æŒ:** å¾…å®š
- **æ–‡æ¡£ç»´æŠ¤:** AIåŠ©æ‰‹ + å¼€å‘å›¢é˜Ÿ

---

**æ–‡æ¡£å®Œæˆï¼** ğŸ‰

ç¥é¡¹ç›®é¡ºåˆ©å®æ–½ï¼


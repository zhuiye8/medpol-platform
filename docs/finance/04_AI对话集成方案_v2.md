# AI对话集成方案 v2.0

> **文档版本:** v2.0
> **更新日期:** 2025-11-15
> **架构模式:** 本地数据库 + OpenAI Function Calling
> **性能目标:** 查询响应时间 < 100ms
> **文档状态:** ✅ 方案定稿

---

## 1. 架构变更说明

### 1.1 旧方案（v1.0）的问题

```
用户提问
  ↓
AI理解意图
  ↓
调用外部API (http://ailianhuan.xyz:8333)  ← 瓶颈1: 网络延迟2-5秒
  ↓
等待API响应（1016条数据，~200KB）         ← 瓶颈2: 数据传输慢
  ↓
AI分析数据
  ↓
返回答案
```

**痛点：**
- ❌ **响应慢** - 每次查询2-5秒（网络+API）
- ❌ **成本高** - 每次对话都调用外部API
- ❌ **不稳定** - 依赖外部API可用性
- ❌ **无法优化** - 无法添加索引、缓存

### 1.2 新方案（v2.0）的优势

```
用户提问
  ↓
AI理解意图
  ↓
调用本地PostgreSQL (通过索引)            ← 优化1: 本地查询<100ms
  ↓
获取精准数据（仅需要的记录）              ← 优化2: 仅传输必要数据
  ↓
AI分析数据
  ↓
返回答案
```

**优势：**
- ✅ **响应快** - 查询时间从2-5秒降至<100ms（**20-50倍提速**）
- ✅ **成本低** - 无额外API调用成本
- ✅ **稳定性高** - 不依赖外部网络
- ✅ **可优化** - 支持索引、缓存、聚合查询

### 1.3 性能对比

| 指标 | 旧方案（v1.0） | 新方案（v2.0） | 提升倍数 |
|------|----------------|----------------|----------|
| 查询响应时间 | 2-5秒 | <100ms | **20-50倍** |
| 数据传输量 | 200KB（全量） | <5KB（按需） | **40倍** |
| API调用成本 | 每次对话1次 | 0次 | **100%节省** |
| 并发能力 | 受限于外部API | 仅受限于PG连接池 | **10倍+** |
| 复杂查询 | 不支持 | 支持聚合/排序/分组 | **质的飞跃** |

---

## 2. AI工具函数设计

### 2.1 工具函数列表

| 工具函数名 | 功能 | 输入参数 | 返回值 |
|-----------|------|---------|--------|
| `query_finance_data` | 多维度查询财务数据 | 公司、类型、时间范围 | 财务记录列表 |
| `analyze_finance_trend` | 趋势分析 | 公司、类型、时间范围 | 同比/环比分析 |
| `get_company_ranking` | 公司排名 | 类型、月份、排序方式 | 排名列表 |
| `compare_companies` | 多公司对比 | 公司列表、类型、月份 | 对比表格 |
| `get_available_months` | 获取可用月份 | 无 | 月份列表 |
| `get_finance_summary` | 财务汇总 | 公司、月份 | 所有类型数据 |

### 2.2 核心工具函数实现

**文件：** `common/clients/finance_data/tools.py`

#### 2.2.1 query_finance_data（基础查询）

```python
def query_finance_data(
    company_names: Optional[List[str]] = None,
    type_no: Optional[str] = None,
    start_month: Optional[str] = None,
    end_month: Optional[str] = None,
    limit: int = 50
) -> Dict[str, Any]:
    """
    查询财务数据

    Args:
        company_names: 公司名称列表，如 ["集团(合)", "股份(合)"]
        type_no: 财务类型编号，如 "01" (营业收入)
        start_month: 开始月份，如 "2024-01"
        end_month: 结束月份，如 "2024-03"
        limit: 返回记录数限制（默认50）

    Returns:
        {
            "total": 26,
            "records": [
                {
                    "company_name": "集团(合)",
                    "type_no": "01",
                    "type_name": "营业收入",
                    "keep_date": "2024-03-01",
                    "current_amt": 54362.20,
                    "year_add_rate": 5.28,
                    ...
                }
            ]
        }
    """
    from common.persistence.finance_database import finance_session_scope
    from finance_sync_service.repository import FinanceDataRepository

    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        # 构建查询条件
        filters = {}
        if company_names:
            filters['company_names'] = company_names
        if type_no:
            filters['type_no'] = type_no
        if start_month:
            filters['start_date'] = datetime.strptime(f"{start_month}-01", "%Y-%m-%d").date()
        if end_month:
            filters['end_date'] = datetime.strptime(f"{end_month}-01", "%Y-%m-%d").date()

        # 执行查询
        records = repo.query_with_filters(filters, limit=limit)

        # 格式化返回
        return {
            "total": len(records),
            "records": [
                {
                    "company_name": r.company_name,
                    "company_no": r.company_no,
                    "type_no": r.type_no,
                    "type_name": FINANCE_TYPE_NAMES.get(r.type_no, "未知"),
                    "keep_date": r.keep_date.isoformat(),
                    "current_amt": float(r.current_amt) if r.current_amt else None,
                    "last_year_amt": float(r.last_year_amt) if r.last_year_amt else None,
                    "this_year_total_amt": float(r.this_year_total_amt) if r.this_year_total_amt else None,
                    "add_rate": float(r.add_rate) if r.add_rate else None,
                    "year_add_rate": float(r.year_add_rate) if r.year_add_rate else None,
                }
                for r in records
            ]
        }
```

#### 2.2.2 analyze_finance_trend（趋势分析）

```python
def analyze_finance_trend(
    company_name: str,
    type_no: str,
    months: int = 6
) -> Dict[str, Any]:
    """
    分析财务趋势（最近N个月）

    Args:
        company_name: 公司名称，如 "集团(合)"
        type_no: 财务类型编号，如 "01"
        months: 分析月份数（默认6个月）

    Returns:
        {
            "company": "集团(合)",
            "type": "营业收入",
            "period": "2024-03 至 2024-08",
            "trend": [
                {"month": "2024-03", "amount": 54362.20, "yoy": 5.28},
                {"month": "2024-04", "amount": 51234.56, "yoy": 3.12},
                ...
            ],
            "summary": {
                "avg_amount": 52345.67,
                "total_amount": 314074.02,
                "avg_yoy": 4.5,
                "trend_direction": "上升"
            }
        }
    """
    from common.persistence.finance_database import finance_session_scope
    from finance_sync_service.repository import FinanceDataRepository

    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        # 获取最近N个月的数据
        records = repo.get_recent_months(
            company_name=company_name,
            type_no=type_no,
            months=months
        )

        if not records:
            return {"error": "未找到数据"}

        # 计算汇总指标
        amounts = [float(r.current_amt) for r in records if r.current_amt]
        yoy_rates = [float(r.year_add_rate) for r in records if r.year_add_rate]

        return {
            "company": company_name,
            "type": FINANCE_TYPE_NAMES.get(type_no, "未知"),
            "period": f"{records[-1].keep_date} 至 {records[0].keep_date}",
            "trend": [
                {
                    "month": r.keep_date.strftime("%Y-%m"),
                    "amount": float(r.current_amt) if r.current_amt else None,
                    "yoy": float(r.year_add_rate) if r.year_add_rate else None,
                    "mom": float(r.add_rate) if r.add_rate else None,
                }
                for r in reversed(records)
            ],
            "summary": {
                "avg_amount": sum(amounts) / len(amounts) if amounts else 0,
                "total_amount": sum(amounts) if amounts else 0,
                "avg_yoy": sum(yoy_rates) / len(yoy_rates) if yoy_rates else 0,
                "trend_direction": "上升" if yoy_rates and yoy_rates[-1] > 0 else "下降"
            }
        }
```

#### 2.2.3 get_company_ranking（公司排名）

```python
def get_company_ranking(
    type_no: str,
    month: str,
    order_by: str = "amount",  # amount | yoy | mom
    top_n: int = 10
) -> Dict[str, Any]:
    """
    获取公司排名

    Args:
        type_no: 财务类型编号，如 "01"
        month: 月份，如 "2024-03"
        order_by: 排序方式（amount=按金额，yoy=按同比，mom=按环比）
        top_n: 返回前N名（默认10）

    Returns:
        {
            "type": "营业收入",
            "month": "2024-03",
            "order_by": "金额",
            "ranking": [
                {"rank": 1, "company": "集团(合)", "amount": 54362.20, "yoy": 5.28},
                {"rank": 2, "company": "股份(合)", "amount": 21271.22, "yoy": 19.78},
                ...
            ]
        }
    """
    from common.persistence.finance_database import finance_session_scope
    from finance_sync_service.repository import FinanceDataRepository

    keep_date = datetime.strptime(f"{month}-01", "%Y-%m-%d").date()

    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        # 查询该月该类型的所有公司数据
        records = repo.query_by_type_and_month(type_no, keep_date)

        # 排序
        if order_by == "amount":
            records = sorted(records, key=lambda r: r.current_amt or 0, reverse=True)
        elif order_by == "yoy":
            records = sorted(records, key=lambda r: r.year_add_rate or -999, reverse=True)
        elif order_by == "mom":
            records = sorted(records, key=lambda r: r.add_rate or -999, reverse=True)

        # 取前N名
        top_records = records[:top_n]

        order_name_map = {"amount": "金额", "yoy": "同比增长率", "mom": "环比增长率"}

        return {
            "type": FINANCE_TYPE_NAMES.get(type_no, "未知"),
            "month": month,
            "order_by": order_name_map.get(order_by, "金额"),
            "ranking": [
                {
                    "rank": idx + 1,
                    "company": r.company_name,
                    "amount": float(r.current_amt) if r.current_amt else None,
                    "yoy": float(r.year_add_rate) if r.year_add_rate else None,
                    "mom": float(r.add_rate) if r.add_rate else None,
                }
                for idx, r in enumerate(top_records)
            ]
        }
```

#### 2.2.4 compare_companies（多公司对比）

```python
def compare_companies(
    company_names: List[str],
    type_no: str,
    month: str
) -> Dict[str, Any]:
    """
    多公司对比

    Args:
        company_names: 公司名称列表，如 ["集团(合)", "股份(合)", "联博(合)"]
        type_no: 财务类型编号，如 "01"
        month: 月份，如 "2024-03"

    Returns:
        {
            "type": "营业收入",
            "month": "2024-03",
            "companies": [
                {"name": "集团(合)", "amount": 54362.20, "yoy": 5.28, "rank": 1},
                {"name": "股份(合)", "amount": 21271.22, "yoy": 19.78, "rank": 2},
                {"name": "联博(合)", "amount": 14841.36, "yoy": -5.71, "rank": 3}
            ],
            "summary": {
                "total_amount": 90474.78,
                "avg_yoy": 6.45,
                "leader": "集团(合)",
                "fastest_growth": "股份(合)"
            }
        }
    """
    from common.persistence.finance_database import finance_session_scope
    from finance_sync_service.repository import FinanceDataRepository

    keep_date = datetime.strptime(f"{month}-01", "%Y-%m-%d").date()

    with finance_session_scope() as session:
        repo = FinanceDataRepository(session)

        # 查询所有公司数据
        records = repo.query_multi_companies(company_names, type_no, keep_date)

        # 按金额排序
        sorted_records = sorted(records, key=lambda r: r.current_amt or 0, reverse=True)

        companies_data = [
            {
                "name": r.company_name,
                "amount": float(r.current_amt) if r.current_amt else None,
                "yoy": float(r.year_add_rate) if r.year_add_rate else None,
                "rank": idx + 1
            }
            for idx, r in enumerate(sorted_records)
        ]

        # 汇总
        amounts = [c["amount"] for c in companies_data if c["amount"]]
        yoys = [c["yoy"] for c in companies_data if c["yoy"]]

        return {
            "type": FINANCE_TYPE_NAMES.get(type_no, "未知"),
            "month": month,
            "companies": companies_data,
            "summary": {
                "total_amount": sum(amounts) if amounts else 0,
                "avg_yoy": sum(yoys) / len(yoys) if yoys else 0,
                "leader": companies_data[0]["name"] if companies_data else None,
                "fastest_growth": max(companies_data, key=lambda x: x["yoy"] or -999)["name"] if companies_data else None
            }
        }
```

---

## 3. OpenAI Function Calling Schema

### 3.1 工具函数定义

**文件：** `common/clients/finance_data/schemas.py`

```python
FINANCE_TOOLS = [
    {
        "type": "function",
        "function": {
            "name": "query_finance_data",
            "description": "查询财务数据，支持按公司、财务类型、时间范围筛选",
            "parameters": {
                "type": "object",
                "properties": {
                    "company_names": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "公司名称列表，如 ['集团(合)', '股份(合)']。可选值：集团(合)、股份(合)、联博(合)、联通医药、基因(合)、产业(合)、普林斯(合)、圣氏化学、颐和堂、华天宝、国药控股"
                    },
                    "type_no": {
                        "type": "string",
                        "enum": ["01", "02", "03", "04", "06", "07", "08"],
                        "description": "财务类型编号。01=营业收入，02=利润总额，03=实现税金，04=入库税金，06=净利润，07=实现税金(扬州)，08=入库税金(扬州)"
                    },
                    "start_month": {
                        "type": "string",
                        "pattern": "^\\d{4}-\\d{2}$",
                        "description": "开始月份，格式：YYYY-MM，如 2024-01"
                    },
                    "end_month": {
                        "type": "string",
                        "pattern": "^\\d{4}-\\d{2}$",
                        "description": "结束月份，格式：YYYY-MM，如 2024-03"
                    },
                    "limit": {
                        "type": "integer",
                        "default": 50,
                        "description": "返回记录数限制（默认50）"
                    }
                }
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "analyze_finance_trend",
            "description": "分析指定公司和财务类型的趋势（最近N个月）",
            "parameters": {
                "type": "object",
                "properties": {
                    "company_name": {
                        "type": "string",
                        "description": "公司名称，如 '集团(合)'"
                    },
                    "type_no": {
                        "type": "string",
                        "enum": ["01", "02", "03", "04", "06", "07", "08"],
                        "description": "财务类型编号"
                    },
                    "months": {
                        "type": "integer",
                        "default": 6,
                        "description": "分析月份数（默认6个月）"
                    }
                },
                "required": ["company_name", "type_no"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_company_ranking",
            "description": "获取指定月份、指定财务类型的公司排名",
            "parameters": {
                "type": "object",
                "properties": {
                    "type_no": {
                        "type": "string",
                        "enum": ["01", "02", "03", "04", "06", "07", "08"],
                        "description": "财务类型编号"
                    },
                    "month": {
                        "type": "string",
                        "pattern": "^\\d{4}-\\d{2}$",
                        "description": "月份，格式：YYYY-MM"
                    },
                    "order_by": {
                        "type": "string",
                        "enum": ["amount", "yoy", "mom"],
                        "default": "amount",
                        "description": "排序方式：amount=按金额，yoy=按同比，mom=按环比"
                    },
                    "top_n": {
                        "type": "integer",
                        "default": 10,
                        "description": "返回前N名"
                    }
                },
                "required": ["type_no", "month"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "compare_companies",
            "description": "对比多个公司在指定月份的财务数据",
            "parameters": {
                "type": "object",
                "properties": {
                    "company_names": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "公司名称列表"
                    },
                    "type_no": {
                        "type": "string",
                        "enum": ["01", "02", "03", "04", "06", "07", "08"],
                        "description": "财务类型编号"
                    },
                    "month": {
                        "type": "string",
                        "pattern": "^\\d{4}-\\d{2}$",
                        "description": "月份，格式：YYYY-MM"
                    }
                },
                "required": ["company_names", "type_no", "month"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_available_months",
            "description": "获取数据库中可用的月份列表",
            "parameters": {
                "type": "object",
                "properties": {}
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_finance_summary",
            "description": "获取指定公司在指定月份的所有财务类型数据汇总",
            "parameters": {
                "type": "object",
                "properties": {
                    "company_name": {
                        "type": "string",
                        "description": "公司名称"
                    },
                    "month": {
                        "type": "string",
                        "pattern": "^\\d{4}-\\d{2}$",
                        "description": "月份，格式：YYYY-MM"
                    }
                },
                "required": ["company_name", "month"]
            }
        }
    }
]
```

### 3.2 工具路由器

**文件：** `common/clients/finance_data/tools.py`

```python
def execute_finance_tool(tool_name: str, arguments: Dict[str, Any]) -> Dict[str, Any]:
    """
    工具函数路由器

    Args:
        tool_name: 工具函数名称
        arguments: 工具函数参数

    Returns:
        工具函数执行结果
    """
    tool_map = {
        "query_finance_data": query_finance_data,
        "analyze_finance_trend": analyze_finance_trend,
        "get_company_ranking": get_company_ranking,
        "compare_companies": compare_companies,
        "get_available_months": get_available_months,
        "get_finance_summary": get_finance_summary,
    }

    if tool_name not in tool_map:
        return {"error": f"Unknown tool: {tool_name}"}

    try:
        result = tool_map[tool_name](**arguments)
        return result
    except Exception as e:
        logger.error(f"Tool execution error: {tool_name}, {e}")
        return {"error": str(e)}
```

---

## 4. 自然语言理解能力

### 4.1 时间推断

**用户输入 → AI理解 → 参数转换**

| 用户输入 | AI理解 | 转换后的参数 |
|---------|--------|-------------|
| "上个月" | 2025年10月（假设当前11月） | `month="2025-10"` |
| "今年3月" | 2025年3月 | `month="2025-03"` |
| "2024年第一季度" | 2024年1-3月 | `start_month="2024-01", end_month="2024-03"` |
| "最近半年" | 最近6个月 | `months=6` |
| "去年同期" | 2024年（假设当前2025年） | `start_month="2024-01", end_month="2024-12"` |

### 4.2 财务类型映射

**用户输入 → AI理解 → type_no**

| 用户输入 | AI理解 | type_no |
|---------|--------|---------|
| "营收"、"收入"、"营业额" | 营业收入 | `"01"` |
| "利润"、"盈利" | 利润总额 | `"02"` |
| "净利"、"税后利润" | 净利润 | `"06"` |
| "税金"、"税收" | 实现税金 | `"03"` |
| "入库税" | 入库税金 | `"04"` |

### 4.3 公司名称模糊匹配

**用户输入 → AI理解 → company_name**

| 用户输入 | AI理解 | 精确名称 |
|---------|--------|---------|
| "集团"、"总公司" | 集团(合) | `"集团(合)"` |
| "股份"、"股份公司" | 股份(合) | `"股份(合)"` |
| "联博" | 联博(合) | `"联博(合)"` |
| "圣氏" | 圣氏化学 | `"圣氏化学"` |
| "国药" | 国药控股 | `"国药控股"` |

### 4.4 System Prompt优化

**文件：** `api_gateway/routers/ai_chat.py`

```python
FINANCE_SYSTEM_PROMPT = """你是一个专业的财务数据分析助手，可以帮助用户查询和分析公司财务数据。

**数据来源：** 本地PostgreSQL数据库（每月1号自动更新）
**数据范围：** 2023年11月 至 2025年9月
**数据更新：** 每月1号凌晨4点自动同步

**公司列表：**
- 集团(合) - 一级公司（总部）
- 股份(合)、联博(合)、联通医药、基因(合)、产业(合)、普林斯(合)、圣氏化学、颐和堂、华天宝、国药控股 - 二级公司（子公司）

**财务类型：**
- 01=营业收入（营收、收入、营业额）
- 02=利润总额（利润、盈利）
- 06=净利润（净利、税后利润）
- 03=实现税金（税金、税收）
- 04=入库税金（入库税）
- 07=实现税金(扬州地区)
- 08=入库税金(扬州地区)

**金额单位：** 万元

**时间理解规则：**
- "上个月" = 当前日期的上一个月
- "今年" = 当前年份
- "去年同期" = 去年对应月份
- "最近半年" = 最近6个月

**回答要求：**
1. 使用工具查询数据，不要凭空回答
2. 金额使用易读格式（如：6.65亿元）
3. 百分比保留2位小数
4. 提供同比/环比分析
5. 总结关键发现和趋势

**示例对话：**
用户："集团上个月的营业收入是多少？"
助手：[调用 query_finance_data(company_names=["集团(合)"], type_no="01", start_month="2025-10", end_month="2025-10")]
助手："2025年10月，集团(合)的营业收入为X.XX亿元，同比增长Y.Y%，环比增长Z.Z%。"
"""
```

---

## 5. 对话流程示例

### 5.1 单轮查询

**用户：** "集团2024年3月的营业收入是多少？"

```
1. AI理解意图
   company_names = ["集团(合)"]
   type_no = "01" (营业收入)
   month = "2024-03"

2. AI调用工具
   Tool: query_finance_data
   Args: {
     "company_names": ["集团(合)"],
     "type_no": "01",
     "start_month": "2024-03",
     "end_month": "2024-03"
   }

3. 数据库查询
   SELECT * FROM finance_data
   WHERE company_name = '集团(合)'
     AND type_no = '01'
     AND keep_date = '2024-03-01'

4. 返回结果
   {
     "total": 1,
     "records": [{
       "company_name": "集团(合)",
       "type_name": "营业收入",
       "keep_date": "2024-03-01",
       "current_amt": 54362.20,
       "year_add_rate": 5.28,
       ...
     }]
   }

5. AI生成回答
   "2024年3月，集团(合)的营业收入为5.44亿元，同比增长5.28%。"
```

**响应时间：** ~1.5秒（AI推理1.4秒 + 数据库查询<100ms）

### 5.2 多轮对话

**对话1：**
用户："集团最近半年的营业收入趋势如何？"

AI调用：`analyze_finance_trend(company_name="集团(合)", type_no="01", months=6)`

AI回答："集团(合)最近6个月的营业收入呈现稳定增长态势，平均营收5.23亿元，同比平均增长4.5%。其中3月份达到最高值5.44亿元。"

**对话2：**
用户："那股份公司呢？"

AI理解：用户继续询问股份公司的营收趋势（复用context中的months=6）

AI调用：`analyze_finance_trend(company_name="股份(合)", type_no="01", months=6)`

AI回答："股份(合)最近6个月平均营收2.13亿元，同比增长率波动较大，3月份同比增长19.78%，表现最佳。"

**对话3：**
用户："对比一下这两家公司"

AI理解：对比集团(合)和股份(合)的营收（结合上下文）

AI调用：`compare_companies(company_names=["集团(合)", "股份(合)"], type_no="01", month="2024-03")`

AI回答："2024年3月，集团(合)营收5.44亿元排名第1，股份(合)营收2.13亿元排名第2。虽然集团营收规模更大，但股份公司的增速更快（19.78% vs 5.28%）。"

### 5.3 复杂分析

**用户：** "帮我分析一下2024年Q1（1-3月）各子公司的利润表现，给出排名和总结"

```
AI理解：
- 时间范围：2024-01 至 2024-03
- 财务类型：02（利润总额）
- 分析维度：子公司排名 + 汇总

AI调用：
Tool 1: query_finance_data
Args: {
  "type_no": "02",
  "start_month": "2024-01",
  "end_month": "2024-03"
}

Tool 2: get_company_ranking
Args: {
  "type_no": "02",
  "month": "2024-03",  # Q1最后一个月
  "order_by": "amount",
  "top_n": 10
}

AI回答：
"2024年第一季度利润表现分析：

**排名前三：**
1. 集团(合) - 8073.47万元（0.81亿元），同比下降8.07%
2. 联博(合) - 1885.05万元，同比增长71.08%
3. 股份(合) - 1295.14万元，同比增长29.83%

**关键发现：**
- 联博(合)虽然利润规模较小，但增速最快（71.08%）
- 集团(合)利润同比下降，需要关注
- Q1总体利润表现稳健，多数子公司实现增长

**建议：**
1. 深入分析集团利润下降原因
2. 学习联博的高增长经验
3. 关注成本控制和运营效率"
```

---

## 6. Repository查询优化

### 6.1 高频查询索引

**已有索引（参考02_数据库设计）：**
```sql
CREATE INDEX idx_finance_data_query ON finance_data(company_no, type_no, keep_date);
```

**查询示例（使用索引）：**
```sql
-- 查询：集团2024年3月营业收入
-- 使用索引：idx_finance_data_query
EXPLAIN ANALYZE
SELECT * FROM finance_data
WHERE company_no = 'lhjt'
  AND type_no = '01'
  AND keep_date = '2024-03-01';

-- 执行时间：< 5ms（索引扫描）
```

### 6.2 聚合查询优化

**文件：** `finance_sync_service/repository.py`

```python
class FinanceDataRepository:
    def get_monthly_summary(self, company_no: str, month: date) -> Dict:
        """
        获取指定公司指定月份的所有财务类型汇总

        优化：单次查询返回所有类型数据
        """
        records = self.session.query(FinanceDataORM).filter(
            FinanceDataORM.company_no == company_no,
            FinanceDataORM.keep_date == month
        ).all()

        return {
            record.type_no: {
                "type_name": FINANCE_TYPE_NAMES.get(record.type_no),
                "current_amt": float(record.current_amt) if record.current_amt else None,
                "year_add_rate": float(record.year_add_rate) if record.year_add_rate else None,
            }
            for record in records
        }

    def get_recent_months(
        self,
        company_name: str,
        type_no: str,
        months: int = 6
    ) -> List[FinanceDataORM]:
        """
        获取最近N个月的数据

        优化：使用子查询获取最新日期，然后向前推N个月
        """
        # 获取最新日期
        latest_date = self.session.query(
            func.max(FinanceDataORM.keep_date)
        ).filter(
            FinanceDataORM.company_name == company_name,
            FinanceDataORM.type_no == type_no
        ).scalar()

        if not latest_date:
            return []

        # 计算起始日期（简化处理，实际应考虑月份差）
        start_date = latest_date.replace(month=latest_date.month - months + 1)

        return self.session.query(FinanceDataORM).filter(
            FinanceDataORM.company_name == company_name,
            FinanceDataORM.type_no == type_no,
            FinanceDataORM.keep_date >= start_date,
            FinanceDataORM.keep_date <= latest_date
        ).order_by(FinanceDataORM.keep_date.desc()).all()
```

### 6.3 查询结果缓存（可选）

```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def query_finance_data_cached(
    company_names_tuple: tuple,  # 必须是不可变类型
    type_no: str,
    start_month: str,
    end_month: str
) -> Dict:
    """
    带缓存的查询（适用于历史数据，不会变化）

    缓存策略：
    - 历史月份（非当前月）数据永久缓存
    - 当前月数据缓存1小时
    """
    company_names = list(company_names_tuple)
    return query_finance_data(company_names, type_no, start_month, end_month, limit=100)

# 清除缓存（每月1号同步后调用）
def clear_finance_cache():
    query_finance_data_cached.cache_clear()
```

---

## 7. 响应格式设计

### 7.1 Markdown 表格格式

**适用场景：** 多条记录展示、排名、对比

```python
def format_as_markdown_table(records: List[Dict]) -> str:
    """将记录格式化为Markdown表格"""
    if not records:
        return "未找到数据"

    # 表头
    header = "| 公司 | 类型 | 月份 | 金额(万元) | 同比增长率 |\n"
    header += "|------|------|------|-----------|------------|\n"

    # 表格行
    rows = []
    for r in records:
        rows.append(
            f"| {r['company_name']} | "
            f"{r['type_name']} | "
            f"{r['keep_date']} | "
            f"{r['current_amt']:,.2f} | "
            f"{r['year_add_rate']:.2f}% |"
        )

    return header + "\n".join(rows)
```

**示例输出：**
```
| 公司 | 类型 | 月份 | 金额(万元) | 同比增长率 |
|------|------|------|-----------|-----------|
| 集团(合) | 营业收入 | 2024-03-01 | 54,362.20 | 5.28% |
| 股份(合) | 营业收入 | 2024-03-01 | 21,271.22 | 19.78% |
```

### 7.2 JSON 结构化格式

**适用场景：** API返回、前端图表

```json
{
  "query": {
    "company": "集团(合)",
    "type": "营业收入",
    "period": "2024-01 至 2024-03"
  },
  "data": [
    {
      "month": "2024-01",
      "amount": 66455.17,
      "yoy": 41.87,
      "mom": null
    },
    {
      "month": "2024-02",
      "amount": 38372.14,
      "yoy": 11.37,
      "mom": -18.85
    },
    {
      "month": "2024-03",
      "amount": 54362.20,
      "yoy": 5.28,
      "mom": -4.75
    }
  ],
  "summary": {
    "avg_amount": 53063.17,
    "total_amount": 159189.51,
    "trend": "上升"
  }
}
```

### 7.3 自然语言格式

**适用场景：** AI对话回答

```python
def format_as_natural_language(data: Dict) -> str:
    """将数据格式化为自然语言"""
    company = data["company"]
    type_name = data["type"]
    month = data["month"]
    amount = data["amount"]
    yoy = data["yoy"]

    # 金额格式化（万元 → 亿元）
    amount_cn = f"{amount / 10000:.2f}亿元" if amount > 10000 else f"{amount:.2f}万元"

    # 增长描述
    growth_desc = f"同比增长{yoy:.2f}%" if yoy > 0 else f"同比下降{abs(yoy):.2f}%"

    return f"{month}，{company}的{type_name}为{amount_cn}，{growth_desc}。"
```

**示例输出：**
```
2024年3月，集团(合)的营业收入为5.44亿元，同比增长5.28%。
```

---

## 8. 相关文档

- [财务数据接口文档](./01_财务数据接口文档.md)
- [财务数据库设计方案](./02_财务数据库设计方案.md)
- [财务数据同步方案](./03_财务数据同步方案.md)
- [财务数据实施路线图](./05_财务数据实施路线图.md)

---

**文档维护:** AI助手 + AI团队
**审核状态:** 待审核
**下一步:** 实现工具函数并集成到AI对话路由
